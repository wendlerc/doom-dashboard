<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doom Policy Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet" />
  <style>
    /* â”€â”€â”€ reset + tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0d0f14;
      --surface: #141720;
      --surface2: #1b1f2e;
      --border: #252a3a;
      --accent: #5e6ad2;
      --accent2: #7c3aed;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --text: #e2e8f0;
      --muted: #64748b;
      --radius: 12px;
      --gap: 20px;
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
    }

    /* â”€â”€â”€ layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .shell {
      display: grid;
      grid-template-rows: 56px 1fr;
      grid-template-columns: 1fr 380px;
      grid-template-areas: "nav nav" "main sidebar";
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€â”€ nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    nav {
      grid-area: nav;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    nav .logo {
      font-size: 20px;
    }

    nav h1 {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: .02em;
    }

    nav .tag {
      margin-left: auto;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: .08em;
      padding: 3px 10px;
      border-radius: 99px;
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    /* â”€â”€â”€ main panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      grid-area: main;
      overflow-y: auto;
      padding: 24px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 16px;
    }

    /* â”€â”€â”€ map grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #map-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--gap);
    }

    .map-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: border-color .2s, transform .2s, box-shadow .2s;
      cursor: default;
    }

    .map-card:hover {
      border-color: var(--accent);
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(94, 106, 210, .18);
    }

    .card-video-wrap {
      position: relative;
      background: #000;
      aspect-ratio: 4/3;
      overflow: hidden;
    }

    .card-video-wrap video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
    }

    /* Native controls (scrubber) appear on hover via JS */

    .card-policy-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(94, 106, 210, .85);
      backdrop-filter: blur(6px);
      font-size: 11px;
      font-weight: 600;
      padding: 3px 9px;
      border-radius: 99px;
      color: #fff;
      letter-spacing: .06em;
    }

    .card-play-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .45);
      opacity: 1;
      transition: opacity .25s;
      pointer-events: none;
    }

    .card-video-wrap:hover .card-play-overlay {
      opacity: 0;
    }

    .play-icon {
      font-size: 40px;
      line-height: 1;
      filter: drop-shadow(0 2px 8px #000);
    }

    .card-body {
      padding: 14px 16px;
    }

    .card-scenario {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .stat-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stat-chip {
      display: flex;
      flex-direction: column;
      background: var(--surface2);
      border-radius: 8px;
      padding: 6px 12px;
      min-width: 70px;
    }

    .stat-label {
      font-size: 9px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .stat-value {
      font-size: 13px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      margin-top: 2px;
    }

    .stat-value.pos {
      color: var(--green);
    }

    .stat-value.neg {
      color: var(--red);
    }

    .stat-value.neu {
      color: var(--yellow);
    }

    /* â”€â”€â”€ empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      grid-column: 1/-1;
      text-align: center;
      padding: 64px 24px;
      color: var(--muted);
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .empty-state code {
      display: inline-block;
      margin-top: 12px;
      background: var(--surface2);
      border-radius: 8px;
      padding: 8px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--accent);
    }

    /* â”€â”€â”€ sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    aside {
      grid-area: sidebar;
      border-left: 1px solid var(--border);
      background: var(--surface);
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* â”€â”€â”€ form groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--muted);
    }

    .form-input,
    .form-select,
    .form-number {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color .15s;
      width: 100%;
    }

    .form-input:focus,
    .form-select:focus,
    .form-number:focus {
      border-color: var(--accent);
    }

    .form-select option {
      background: var(--surface2);
    }

    /* ratio table */
    .ratio-table {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .ratio-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ratio-name {
      font-size: 12px;
      white-space: nowrap;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ratio-input {
      width: 60px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
      transition: border-color .15s;
    }

    .ratio-input:focus {
      border-color: var(--accent);
    }

    hr.divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 4px 0;
    }

    /* â”€â”€â”€ buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s, transform .1s;
      width: 100%;
    }

    .btn:hover {
      opacity: .88;
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
    }

    .btn-danger {
      background: rgba(239, 68, 68, .18);
      color: var(--red);
      border: 1px solid var(--red);
    }

    .btn:disabled {
      opacity: .4;
      cursor: not-allowed;
      transform: none;
    }

    /* â”€â”€â”€ progress card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #job-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    #job-card.visible {
      display: flex;
    }

    .progress-bar-bg {
      background: var(--surface2);
      border-radius: 99px;
      height: 6px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 99px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .4s;
    }

    #job-log {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      max-height: 120px;
      overflow-y: auto;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    /* â”€â”€â”€ preview generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #preview-result {
      display: none;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--accent);
      box-shadow: 0 0 24px rgba(94, 106, 210, .25);
    }

    #preview-result video {
      width: 100%;
      display: block;
    }

    #preview-meta {
      padding: 12px 14px;
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      color: var(--muted);
      background: var(--surface2);
      line-height: 1.8;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, .3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #preview-error {
      display: none;
      padding: 10px 14px;
      background: rgba(239, 68, 68, .12);
      border: 1px solid var(--red);
      border-radius: 8px;
      font-size: 12px;
      color: var(--red);
    }
  </style>
</head>

<body>
  <div class="shell">

    <!-- NAV -->
    <nav>
      <span class="logo">ğŸ®</span>
      <h1>Doom Policy Dashboard</h1>
      <span class="tag">EVALUATION</span>
    </nav>

    <!-- MAIN: Map Grid -->
    <main>
      <p class="section-title">Sample Episodes â€” 1 per Map Ã— Policy</p>
      <div id="map-grid">
        <div class="empty-state">
          <div class="icon">ğŸ“½ï¸</div>
          <h2>No samples yet</h2>
          <p>Generate sample games first:</p>
          <code>uv run python -m doom_dashboard.cli generate-samples --config config.yaml</code>
        </div>
      </div>
    </main>

    <!-- SIDEBAR -->
    <aside>
      <!-- â”€â”€ Preview Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <p class="section-title">ğŸ¬ Preview Generator</p>

      <div class="form-group">
        <span class="form-label">SCENARIO</span>
        <select class="form-select" id="prev-scenario"></select>
      </div>

      <div class="form-group">
        <span class="form-label">POLICY</span>
        <select class="form-select" id="prev-policy"></select>
      </div>

      <div class="form-group" style="flex-direction:row;align-items:center;gap:8px">
        <input type="checkbox" id="prev-match-policy" style="accent-color:var(--accent);width:16px;height:16px" checked />
        <span class="form-label" style="margin:0">AUTO-MATCH SCENARIO TO POLICY</span>
      </div>

      <div class="form-group">
        <span class="form-label">MAP (OPTIONAL, e.g. map01)</span>
        <input class="form-input" type="text" id="prev-map" placeholder="leave blank for scenario default" />
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="form-group">
          <span class="form-label">FRAME SKIP</span>
          <input class="form-number" type="number" id="prev-frameskip" value="4" min="1" max="16" step="1" />
        </div>
        <div class="form-group">
          <span class="form-label">DURATION (s)</span>
          <input class="form-number" type="number" id="prev-timelimit" value="120" min="5" max="1800" step="5" />
        </div>
      </div>

      <div class="form-group">
        <span class="form-label">RESOLUTION</span>
        <select class="form-select" id="prev-resolution">
          <option>RES_160X120</option>
          <option selected>RES_320X240</option>
          <option>RES_640X480</option>
        </select>
      </div>

      <div class="form-group" style="flex-direction:row;align-items:center;gap:8px">
        <input type="checkbox" id="prev-hud" style="accent-color:var(--accent);width:16px;height:16px" />
        <span class="form-label" style="margin:0">RENDER HUD</span>
      </div>

      <button class="btn btn-primary" id="prev-btn" onclick="generatePreview()">
        â–¶ Generate Preview
      </button>

      <div id="preview-error"></div>

      <div id="preview-result">
        <video id="prev-video" autoplay loop muted controls></video>
        <div style="padding:8px 14px;background:var(--surface2);border-top:1px solid var(--border)">
          <a id="preview-open-link" href="#" target="_blank" rel="noopener noreferrer" style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--accent)">Open preview video in new tab</a>
        </div>
        <div id="preview-meta"></div>
      </div>

      <hr class="divider" />

      <!-- â”€â”€ Dataset Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <p class="section-title">Dataset Generator</p>

      <!-- Scenarios -->
      <div class="form-group">
        <span class="form-label">SCENARIO RATIOS</span>
        <div class="ratio-table" id="scenario-ratios"></div>
      </div>

      <hr class="divider" />

      <!-- Policies -->
      <div class="form-group">
        <span class="form-label">POLICY RATIOS</span>
        <div class="ratio-table" id="policy-ratios"></div>
      </div>

      <hr class="divider" />

      <!-- Hyper-parameters -->
      <div class="form-group">
        <span class="form-label">TOTAL HOURS</span>
        <input class="form-number" type="number" id="total-hours" value="2.0" min="0.1" step="0.1" />
      </div>

      <div class="form-group">
        <span class="form-label">FRAME SKIP</span>
        <input class="form-number" type="number" id="frame-skip" value="4" min="1" max="16" step="1" />
      </div>

      <div class="form-group">
        <span class="form-label">RENDER RESOLUTION</span>
        <select class="form-select" id="resolution">
          <option>RES_160X120</option>
          <option>RES_320X240</option>
          <option selected>RES_320X240</option>
          <option>RES_640X480</option>
          <option>RES_800X600</option>
        </select>
      </div>

      <div class="form-group">
        <span class="form-label">SHARD SIZE (MB)</span>
        <input class="form-number" type="number" id="shard-size" value="512" min="64" max="4096" step="64" />
      </div>

      <div class="form-group">
        <span class="form-label">WORKERS (blank = auto)</span>
        <input class="form-number" type="number" id="num-workers" placeholder="auto" min="1" max="256" />
      </div>

      <div class="form-group">
        <span class="form-label">OUTPUT DIRECTORY</span>
        <input class="form-input" type="text" id="output-dir" value="dataset" />
      </div>

      <!-- Launch button -->
      <button class="btn btn-primary" id="launch-btn" onclick="launchDataset()">
        âš¡ Launch Dataset Generation
      </button>

      <!-- Progress card -->
      <div id="job-card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <span style="font-size:12px;font-weight:600" id="job-status-label">Runningâ€¦</span>
          <span style="font-size:11px;color:var(--muted)" id="job-pct">0%</span>
        </div>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="job-bar" style="width:0%"></div>
        </div>
        <div id="job-log"></div>
        <button class="btn btn-danger" onclick="cancelJob()" id="cancel-btn">âœ• Cancel</button>
      </div>
    </aside>

  </div>

  <script>
    /* â”€â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    let _cfg = null;
    let _sseSource = null;

    async function init() {
      const [sampRes, cfgRes] = await Promise.all([
        fetch('/api/samples'),
        fetch('/api/config'),
      ]);
      const { samples } = await sampRes.json();
      _cfg = await cfgRes.json();

      renderSamples(samples);
      populateRatios();
      populatePreviewSelects();

      // Pre-fill form from config
      document.getElementById('total-hours').value = _cfg.dataset.total_hours;
      document.getElementById('frame-skip').value = _cfg.dataset.frame_skip;
      document.getElementById('shard-size').value = _cfg.dataset.shard_size_mb;
      document.getElementById('output-dir').value = _cfg.dataset.output_dir;
      const resSelect = document.getElementById('resolution');
      resSelect.value = _cfg.dataset.render_resolution;
    }

    /* â”€â”€â”€ sample cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderSamples(samples) {
      const grid = document.getElementById('map-grid');
      if (!samples || samples.length === 0) return;
      grid.innerHTML = '';
      for (const s of samples) {
        const rewardClass = s.total_reward > 0 ? 'pos' : s.total_reward < 0 ? 'neg' : 'neu';
        const durMin = (s.duration_s / 60).toFixed(1);
        const isHeadToHead = s.total_reward_p1 !== undefined && s.total_reward_p2 !== undefined;
        const uid = 'v' + Math.random().toString(36).slice(2);
        const rewardHtml = isHeadToHead
          ? `<span class=\"stat-label\">R1 / R2</span>
             <span class=\"stat-value neu\">${Number(s.total_reward_p1).toFixed(1)} / ${Number(s.total_reward_p2).toFixed(1)}</span>`
          : `<span class=\"stat-label\">Reward</span>
             <span class=\"stat-value ${rewardClass}\">${s.total_reward.toFixed(1)}</span>`;
        grid.insertAdjacentHTML('beforeend', `
      <div class="map-card">
        <div class="card-video-wrap">
          <video id="${uid}" src="/videos/${s.video}?v=${Date.now()}" loop muted preload="auto"
                 style="cursor:pointer"
                 onmouseenter="this.play();this.controls=true"
                 onmouseleave="this.pause();this.currentTime=0;this.controls=false">
          </video>
          <div class="card-play-overlay" id="ov-${uid}">
            <span class="play-icon">â–¶</span>
          </div>
          <span class="card-policy-badge">${s.policy}</span>
        </div>
        <div class="card-body">
          <div class="card-scenario">${s.scenario}</div>
          <div class="stat-row">
            <div class="stat-chip">
              ${rewardHtml}
            </div>
            <div class="stat-chip">
              <span class="stat-label">Steps</span>
              <span class="stat-value neu">${s.steps}</span>
            </div>
            <div class="stat-chip">
              <span class="stat-label">Duration</span>
              <span class="stat-value neu">${durMin}m</span>
            </div>
          </div>
        </div>
      </div>
    `);
        // hide overlay when video starts playing
        const vid = document.getElementById(uid);
        vid.addEventListener('play', () => { const ov = document.getElementById('ov-' + uid); if (ov) ov.style.opacity = '0'; });
        vid.addEventListener('pause', () => { const ov = document.getElementById('ov-' + uid); if (ov) ov.style.opacity = '1'; });
      }
    }

    /* â”€â”€â”€ ratio tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function populateRatios() {
      if (!_cfg) return;

      const fillTable = (containerId, items, existingRatios) => {
        const c = document.getElementById(containerId);
        c.innerHTML = '';
        const n = items.length;
        for (const item of items) {
          const name = item.name;
          const defaultVal = (existingRatios[name] ?? (1.0 / n)).toFixed(2);
          c.insertAdjacentHTML('beforeend', `
        <div class="ratio-row">
          <span class="ratio-name" title="${name}">${name}</span>
          <input class="ratio-input" type="number" id="sc-ratio-${name}"
                 value="${defaultVal}" min="0" max="1" step="0.05" />
        </div>
      `);
        }
      };

      fillTable('scenario-ratios', _cfg.scenarios, _cfg.dataset.scenario_ratios || {});
      fillTable('policy-ratios', _cfg.policies, _cfg.dataset.policy_ratios || {});
    }

    function collectRatios(containerId, items) {
      const ratios = {};
      for (const item of items) {
        const el = document.getElementById(`sc-ratio-${item.name}`);
        if (el) ratios[item.name] = parseFloat(el.value) || 0;
      }
      return ratios;
    }

    /* â”€â”€â”€ launch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function launchDataset() {
      const body = {
        total_hours: parseFloat(document.getElementById('total-hours').value),
        frame_skip: parseInt(document.getElementById('frame-skip').value),
        render_resolution: document.getElementById('resolution').value,
        shard_size_mb: parseInt(document.getElementById('shard-size').value),
        output_dir: document.getElementById('output-dir').value,
        scenario_ratios: collectRatios('scenario-ratios', _cfg.scenarios),
        policy_ratios: collectRatios('policy-ratios', _cfg.policies),
        num_workers: parseInt(document.getElementById('num-workers').value) || null,
      };

      const res = await fetch('/api/launch-dataset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const json = await res.json();

      if (!json.ok) {
        alert('Error: ' + (json.error || 'Unknown'));
        return;
      }

      const card = document.getElementById('job-card');
      card.classList.add('visible');
      document.getElementById('launch-btn').disabled = true;
      document.getElementById('job-log').textContent = '';
      startSSE(body.total_hours);
    }

    function startSSE(totalHours) {
      if (_sseSource) _sseSource.close();
      _sseSource = new EventSource('/api/dataset-stream');
      _sseSource.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.done) {
          document.getElementById('job-status-label').textContent = 'âœ“ Done';
          document.getElementById('job-bar').style.width = '100%';
          document.getElementById('job-pct').textContent = '100%';
          document.getElementById('launch-btn').disabled = false;
          _sseSource.close();
          return;
        }
        const pct = Math.min(100, ((d.hours_done / d.total) * 100)).toFixed(1);
        document.getElementById('job-bar').style.width = pct + '%';
        document.getElementById('job-pct').textContent = pct + '%';
        document.getElementById('job-status-label').textContent = d.running ? 'Runningâ€¦' : 'âœ“ Done';
        if (d.log) {
          const logEl = document.getElementById('job-log');
          logEl.textContent += d.log + '\n';
          logEl.scrollTop = logEl.scrollHeight;
        }
      };
    }

    function cancelJob() {
      if (_sseSource) { _sseSource.close(); _sseSource = null; }
      document.getElementById('launch-btn').disabled = false;
      document.getElementById('job-status-label').textContent = 'Cancelled by user';
    }

    /* â”€â”€â”€ preview generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function populatePreviewSelects() {
      if (!_cfg) return;
      const sc = document.getElementById('prev-scenario');
      const po = document.getElementById('prev-policy');
      sc.innerHTML = _cfg.scenarios.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
      po.innerHTML = _cfg.policies.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
      po.addEventListener('change', maybeMatchScenarioToPolicy);
      const match = document.getElementById('prev-match-policy');
      match.addEventListener('change', maybeMatchScenarioToPolicy);
      maybeMatchScenarioToPolicy();
    }

    function _canonName(s) {
      return (s || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function maybeMatchScenarioToPolicy() {
      if (!_cfg) return;
      const matchEnabled = document.getElementById('prev-match-policy').checked;
      if (!matchEnabled) return;
      const polName = document.getElementById('prev-policy').value || '';
      const scSelect = document.getElementById('prev-scenario');
      const pol = (_cfg.policies || []).find(p => p.name === polName);
      if (pol && pol.expected_scenario) {
        const key = _canonName(pol.expected_scenario);
        const exact = (_cfg.scenarios || []).find(s => _canonName(s.cfg || s.name) === key || _canonName(s.name) === key);
        if (exact) {
          scSelect.value = exact.name;
          return;
        }
      }
      const polCanon = _canonName(polName.replace(/^ppo[-_]?/i, ''));
      const target = (_cfg.scenarios || []).find(s => polCanon && _canonName(s.name).includes(polCanon));
      if (target) scSelect.value = target.name;
    }

    let _prevPoll = null;
    async function generatePreview() {
      const btn = document.getElementById('prev-btn');
      const errEl = document.getElementById('preview-error');
      const resEl = document.getElementById('preview-result');
      const metaEl = document.getElementById('preview-meta');
      errEl.style.display = 'none';
      resEl.style.display = 'none';
      metaEl.textContent = '';

      const body = {
        scenario: document.getElementById('prev-scenario').value,
        policy: document.getElementById('prev-policy').value,
        frame_skip: parseInt(document.getElementById('prev-frameskip').value),
        timelimit_secs: parseInt(document.getElementById('prev-timelimit').value),
        resolution: document.getElementById('prev-resolution').value,
        render_hud: document.getElementById('prev-hud').checked,
        map: document.getElementById('prev-map').value,
      };

      let res, json;
      try {
        res = await fetch('/api/generate-preview', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body),
        });
        json = await res.json();
      } catch (e) {
        errEl.textContent = 'Could not reach dashboard server. Check port-forwarding and refresh.';
        errEl.style.display = 'block';
        return;
      }
      if (!json.ok) { errEl.textContent = json.error; errEl.style.display = 'block'; return; }

      btn.innerHTML = '<span class="spinner"></span> Generatingâ€¦';
      btn.disabled = true;
      metaEl.textContent = 'Generating preview...';

      if (_prevPoll) clearInterval(_prevPoll);
      _prevPoll = setInterval(async () => {
        let st;
        try {
          st = await fetch('/api/preview-status').then(r => r.json());
        } catch (e) {
          clearInterval(_prevPoll);
          btn.innerHTML = 'â–¶ Generate Preview'; btn.disabled = false;
          errEl.textContent = 'Lost connection while waiting for preview. Try again.';
          errEl.style.display = 'block';
          return;
        }
        if (st.error) {
          clearInterval(_prevPoll);
          btn.innerHTML = 'â–¶ Generate Preview'; btn.disabled = false;
          errEl.textContent = 'Error: ' + st.error; errEl.style.display = 'block';
        } else if (!st.running && st.video) {
          clearInterval(_prevPoll);
          btn.innerHTML = 'â–¶ Generate Preview'; btn.disabled = false;
          const vid = document.getElementById('prev-video');
          const videoUrl = '/previews/' + st.video + '?t=' + Date.now();
          vid.src = videoUrl;
          const openLink = document.getElementById('preview-open-link');
          openLink.href = videoUrl;
          vid.load();
          vid.play().catch(() => {});
          const m = st.meta;
          document.getElementById('preview-meta').innerHTML =
            `Reward: <b style="color:${m.total_reward >= 0 ? '#22c55e' : '#ef4444'}">${m.total_reward.toFixed(1)}</b> &nbsp;|
         Steps: <b>${m.steps}</b> &nbsp;|
         Frame-skip: <b>${m.frame_skip}</b> &nbsp;|
         Resolution: <b>${m.resolution}</b> &nbsp;|
         FPS: <b>${m.fps}</b> &nbsp;|
         Map: <b>${m.map || 'default'}</b>`;
          resEl.style.display = 'block';
          resEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else if (!st.running && !st.video) {
          clearInterval(_prevPoll);
          btn.innerHTML = 'â–¶ Generate Preview'; btn.disabled = false;
          errEl.textContent = 'Preview finished but no video was returned. Check server logs.';
          errEl.style.display = 'block';
        }
      }, 2000);
    }

    init();
  </script>
</body>

</html>
